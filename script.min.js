// World Clock Wallpaper Extension Script - Optimized for Production
class WorldClockWallpaper {
    constructor() {
        this.config = {
            bgColor: '#1a1a2e',
            fontColor: '#ffffff',
            fontFamily: 'Arial, sans-serif',
            fontSize: 16,
            timeFormat: '24',
            dateFormat: 'long',
            additionalTimezones: []
        };
        this.clockIntervals = [];
        this.domCache = new Map();
        this.updateQueue = [];
        this.isUpdating = false;
        this.timezoneFormatters = new Map();
        this.activeNotification = null;
        this.init();
    }
    
    validateColor(c){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(c)?c:this.config.bgColor}
    validateFontSize(s){s=parseInt(s);return s>=12&&s<=48?s:16}
    validateTimeFormat(f){return['12','24'].includes(f)?f:'24'}
    validateDateFormat(f){return['short','medium','long'].includes(f)?f:'long'}
    sanitizeTimezone(t){return t.replace(/[^a-zA-Z0-9_\/-]/g,'').substring(0,50)}
    sanitizeElementId(i){return i.replace(/[^a-zA-Z0-9_-]/g,'-')}
    
    getCachedElement(s){
        if(!this.domCache.has(s)){
            const e=document.querySelector(s);
            if(e)this.domCache.set(s,e);
        }
        return this.domCache.get(s);
    }
    
    clearDOMCache(){this.domCache.clear()}
    
    batchUpdate(fn){
        this.updateQueue.push(fn);
        if(!this.isUpdating){
            this.isUpdating=!0;
            requestAnimationFrame(()=>{
                this.updateQueue.forEach(f=>f());
                this.updateQueue=[];
                this.isUpdating=!1;
            });
        }
    }
    
    async init(){
        await this.loadConfig();
        this.populateTimezones();
        this.applyConfig();
        this.setupEventListeners();
        this.startClocks();
    }
    
    async loadConfig(){
        try{
            const s=await chrome.storage.sync.get('worldClockConfig');
            if(s.worldClockConfig)this.config={...this.config,...s.worldClockConfig};
        }catch(e){}
    }
    
    async saveConfig(){
        const b=document.getElementById('saveBtn');
        const o=b.textContent;
        try{
            b.classList.add('loading');
            b.textContent='Saving...';
            b.disabled=!0;
            await chrome.storage.sync.set({worldClockConfig:this.config});
            this.showNotification('Configuration saved successfully!');
        }catch(e){
            this.showNotification('Failed to save configuration','error');
        }finally{
            b.classList.remove('loading');
            b.textContent=o;
            b.disabled=!1;
        }
    }
    
    populateTimezones(){
        const t=document.getElementById('timezoneSelect');
        const a=document.getElementById('addTimezone');
        const o=a.textContent;
        t.classList.add('loading');
        a.disabled=!0;
        a.textContent='Loading...';
        try{
            const r=Intl.supportedValuesOf('timeZone');
            const s=r.sort((a,b)=>{const c=a.split('/')[0],d=b.split('/')[0];return c!==d?c.localeCompare(d):a.localeCompare(b)});
            const n={};
            s.forEach(a=>{const b=a.split('/')[0];n[b]||(n[b]=[]);n[b].push(a)});
            t.textContent='';
            const l=document.createElement('option');
            l.value='';l.textContent='Select timezone...';t.appendChild(l);
            Object.keys(n).sort().forEach(a=>{const b=document.createElement('optgroup');b.label=a;n[a].forEach(a=>{const c=document.createElement('option');c.value=a;c.textContent=a.split('/').slice(1).join('/').replace(/_/g,' ');b.appendChild(c)});t.appendChild(b)});
        }catch(e){
            t.textContent='';
            const l=document.createElement('option');
            l.value='';l.textContent='Select timezone...';t.appendChild(l);
            ['America/New_York','America/Los_Angeles','America/Chicago','Europe/London','Europe/Paris','Asia/Tokyo','Asia/Shanghai','Asia/Dubai','Australia/Sydney','Pacific/Auckland'].forEach(a=>{const b=document.createElement('option');b.value=a;b.textContent=a.split('/').pop().replace(/_/g,' ');t.appendChild(b)});
        }
        t.classList.remove('loading');
        a.disabled=!1;
        a.textContent=o;
    }
    
    applyConfig(){
        this.batchUpdate(()=>{
            document.body.style.backgroundColor=this.config.bgColor;
            document.body.style.color=this.config.fontColor;
            document.body.style.fontFamily=this.config.fontFamily;
            document.body.style.fontSize=this.config.fontSize+'px';
        });
        const b=document.getElementById('bgColor'),c=document.getElementById('fontColor'),d=document.getElementById('fontFamily'),e=document.getElementById('fontSize'),f=document.getElementById('fontSizeValue'),g=document.getElementById('timeFormat'),h=document.getElementById('dateFormat');
        if(b)b.value=this.config.bgColor;if(c)c.value=this.config.fontColor;if(d)d.value=this.config.fontFamily;if(e){e.value=this.config.fontSize;e.setAttribute('aria-valuenow',this.config.fontSize);e.setAttribute('aria-valuetext',`${this.config.fontSize} pixels`);}if(f)f.textContent=this.config.fontSize+'px';if(g)g.value=this.config.timeFormat;if(h)h.value=this.config.dateFormat;
        this.updateTimezonesDisplay();
    }
    
    setupEventListeners(){
        const s=this.getCachedElement('#settingsBtn'),c=this.getCachedElement('#configPanel'),l=this.getCachedElement('#closeConfig'),a=this.getCachedElement('#aboutBtn'),b=this.getCachedElement('#aboutPopup'),o=this.getCachedElement('#closeAbout');
        if(s){this.settingsClickHandler=()=>this.openConfigPanel();s.addEventListener('click',this.settingsClickHandler);}
        if(l){this.closeConfigHandler=()=>this.closeConfigPanel();l.addEventListener('click',this.closeConfigHandler);}
        if(a){this.aboutClickHandler=()=>this.openAboutPopup();a.addEventListener('click',this.aboutClickHandler);}
        if(o){this.closeAboutHandler=()=>this.closeAboutPopup();o.addEventListener('click',this.closeAboutHandler);}
        this.setupFormListeners();
        this.keyboardHandler=e=>this.handleKeyboard(e);
        document.addEventListener('keydown',this.keyboardHandler);
        this.clickOutsideHandler=e=>this.handleClickOutside(e);
        document.addEventListener('click',this.clickOutsideHandler);
        const y=document.getElementById('currentYear');
        if(y)y.textContent=new Date().getFullYear();
    }
    
    openConfigPanel(){
        const p=this.getCachedElement('#configPanel'),s=this.getCachedElement('#settingsBtn');
        if(p&&s){
            p.classList.add('open');
            p.setAttribute('aria-hidden','false');
            s.setAttribute('aria-expanded','true');
            const i=this.getCachedElement('#bgColor');
            if(i)i.focus();
        }
    }
    
    closeConfigPanel(){
        const p=this.getCachedElement('#configPanel'),s=this.getCachedElement('#settingsBtn');
        if(p&&s){
            p.classList.remove('open');
            p.setAttribute('aria-hidden','true');
            s.setAttribute('aria-expanded','false');
            s.focus();
        }
    }
    
    openAboutPopup(){
        const p=this.getCachedElement('#aboutPopup'),a=this.getCachedElement('#aboutBtn');
        if(p&&a){
            p.classList.add('open');
            p.setAttribute('aria-hidden','false');
            a.setAttribute('aria-expanded','true');
        }
    }
    
    closeAboutPopup(){
        const p=this.getCachedElement('#aboutPopup'),a=this.getCachedElement('#aboutBtn');
        if(p&&a){
            p.classList.remove('open');
            p.setAttribute('aria-hidden','true');
            a.setAttribute('aria-expanded','false');
            a.focus();
        }
    }
    
    handleKeyboard(e){
        if(e.ctrlKey||e.metaKey){
            switch(e.key){
                case's':e.preventDefault();const c=this.getCachedElement('#configPanel');if(c&&c.classList.contains('open'))this.saveConfig();break;
                case',':e.preventDefault();this.openConfigPanel();break;
            }
        }else if(e.key==='Escape'){
            const c=this.getCachedElement('#configPanel');if(c&&c.classList.contains('open'))this.closeConfigPanel();
            const a=this.getCachedElement('#aboutPopup');if(a&&a.classList.contains('open'))this.closeAboutPopup();
        }else if(e.key==='?')this.openAboutPopup();
    }
    
    handleClickOutside(e){
        const p=this.getCachedElement('#configPanel'),s=this.getCachedElement('#settingsBtn');
        if(p&&s&&!p.contains(e.target)&&e.target!==s&&p.classList.contains('open'))this.closeConfigPanel();
        const a=this.getCachedElement('#aboutPopup');if(a&&e.target===a&&a.classList.contains('open'))this.closeAboutPopup();
    }
    
    setupFormListeners(){
        const b=this.getCachedElement('#bgColor');if(b){this.bgColorHandler=e=>{const c=this.validateColor(e.target.value);this.config.bgColor=c;this.batchUpdate(()=>{document.body.style.backgroundColor=c;});};b.addEventListener('input',this.bgColorHandler);}
        const c=this.getCachedElement('#fontColor');if(c){this.fontColorHandler=e=>{const f=this.validateColor(e.target.value);this.config.fontColor=f;this.batchUpdate(()=>{document.body.style.color=f;});};c.addEventListener('input',this.fontColorHandler);}
        const d=this.getCachedElement('#fontSize');if(d){this.fontSizeHandler=e=>{const s=this.validateFontSize(e.target.value);this.config.fontSize=s;this.batchUpdate(()=>{document.body.style.fontSize=s+'px';});const v=document.getElementById('fontSizeValue');if(v)v.textContent=s+'px';d.setAttribute('aria-valuenow',s);d.setAttribute('aria-valuetext',`${s} pixels`);};d.addEventListener('input',this.fontSizeHandler);}
        const g=this.getCachedElement('#timeFormat');if(g){this.timeFormatHandler=e=>{const f=this.validateTimeFormat(e.target.value);this.config.timeFormat=f;this.updateAllClocks();};g.addEventListener('change',this.timeFormatHandler);}
        const h=this.getCachedElement('#dateFormat');if(h){this.dateFormatHandler=e=>{const f=this.validateDateFormat(e.target.value);this.config.dateFormat=f;this.updateAllClocks();};h.addEventListener('change',this.dateFormatHandler);}
        const t=this.getCachedElement('#timezoneSelect'),a=this.getCachedElement('#addTimezone');if(a){this.addTimezoneHandler=()=>{const s=t.value;if(s&&!this.config.additionalTimezones.includes(s)){this.config.additionalTimezones.push(s);this.updateTimezonesDisplay();this.addAdditionalClock(s);t.value='';}};a.addEventListener('click',this.addTimezoneHandler);}
        const saveBtn=this.getCachedElement('#saveConfig');if(saveBtn){this.saveHandler=()=>this.saveConfig();saveBtn.addEventListener('click',this.saveHandler);}
        const resetBtn=this.getCachedElement('#resetConfig');if(resetBtn){this.resetHandler=()=>{if(confirm('Are you sure you want to reset to default settings?'))this.resetToDefault();};resetBtn.addEventListener('click',this.resetHandler);}
    }
    
    startClocks(){
        this.clockIntervals.forEach(i=>clearInterval(i));this.clockIntervals=[];
        this.updateMainClock();const i=setInterval(()=>this.updateMainClock(),1000);this.clockIntervals.push(i);
        this.config.additionalTimezones.forEach(t=>this.addAdditionalClock(t));
    }
    
    updateMainClock(){
        const now=new Date(),timeEl=this.getCachedElement('#mainTime'),dateEl=this.getCachedElement('#mainDate'),tzEl=this.getCachedElement('#mainTimezone');
        this.batchUpdate(()=>{
            if(timeEl)timeEl.textContent=this.formatTime(now);
            if(dateEl)dateEl.textContent=this.formatDate(now);
            try{const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;const name=this.formatTimezoneName(tz);if(tzEl&&tzEl.textContent!==name)tzEl.textContent=name}catch(e){if(tzEl&&tzEl.textContent!=='Local Time')tzEl.textContent='Local Time';}
        });
    }
    
    addAdditionalClock(tz){
        const container=document.getElementById('additionalClocks'),safeId=`clock-${this.sanitizeElementId(tz)}`,clockEl=document.getElementById(safeId);
        if(!clockEl){
            const el=document.createElement('div');el.className='additional-clock';el.id=safeId;el.textContent='';
            const timeDiv=document.createElement('div');timeDiv.className='time';const dateDiv=document.createElement('div');dateDiv.className='date';const tzDiv=document.createElement('div');tzDiv.className='timezone';
            el.appendChild(timeDiv);el.appendChild(dateDiv);el.appendChild(tzDiv);el.setAttribute('role','timer');el.setAttribute('aria-live','polite');el.setAttribute('aria-atomic','true');el.setAttribute('aria-label',`Clock for ${this.formatTimezoneName(tz)}`);
            container.appendChild(el);
        }
        this.updateAdditionalClock(tz,document.getElementById(safeId));
        const i=setInterval(()=>this.updateAdditionalClock(tz,document.getElementById(safeId)),1000);this.clockIntervals.push(i);
    }
    
    updateAdditionalClock(tz,clockEl){
        try{
            const now=new Date(),key=`${tz}-${this.config.timeFormat}`;
            if(!this.timezoneFormatters.has(key)){
                const opts={timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:this.config.timeFormat==='12'};
                this.timezoneFormatters.set(key,new Intl.DateTimeFormat('en-US',opts));
            }
            const timeStr=this.formatTimeForTimezone(now,tz),dateStr=this.formatDateForTimezone(now,tz),tzName=this.formatTimezoneName(tz);
            this.batchUpdate(()=>{
                const timeEl=clockEl.querySelector('.time'),dateEl=clockEl.querySelector('.date'),tzEl=clockEl.querySelector('.timezone');
                if(timeEl)timeEl.textContent=timeStr;if(dateEl)dateEl.textContent=dateStr;if(tzEl)tzEl.textContent=tzName;
            });
        }catch(e){}
    }
    
    formatTime(d){return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:this.config.timeFormat==='12'});}
    formatDate(d){if(this.config.dateFormat==='medium')return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});if(this.config.dateFormat==='short')return d.toLocaleDateString('en-US');return d.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});}
    formatTimeForTimezone(d,tz){return d.toLocaleTimeString('en-US',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:this.config.timeFormat==='12'});}
    formatDateForTimezone(d,tz){const opts={timeZone:tz,year:'numeric',month:'short',day:'numeric'};if(this.config.dateFormat==='short')return d.toLocaleDateString('en-US',{timeZone:tz});if(this.config.dateFormat==='long'){opts.weekday='long';opts.month='long';}return d.toLocaleDateString('en-US',opts);}
    formatTimezoneName(tz){return tz.split('/').pop().replace(/_/g,' ');}
    
    updateTimezonesDisplay(){
        const container=document.getElementById('addedTimezones');if(!container)return;
        container.textContent='';
        this.config.additionalTimezones.forEach(tz=>{
            const item=document.createElement('div');item.className='timezone-item';
            const name=this.formatTimezoneName(tz),nameSpan=document.createElement('span');nameSpan.textContent=name;nameSpan.setAttribute('aria-label',`Timezone: ${name}`);
            const rmBtn=document.createElement('button');rmBtn.className='remove-btn';rmBtn.textContent='Remove';rmBtn.dataset.timezone=tz;rmBtn.setAttribute('aria-label',`Remove ${name} timezone`);
            item.setAttribute('role','listitem');item.appendChild(nameSpan);item.appendChild(rmBtn);container.appendChild(item);
        });
        container.querySelectorAll('.remove-btn').forEach(btn=>{btn.addEventListener('click',e=>{const tz=e.target.dataset.timezone;this.removeTimezone(tz);});});
    }
    
    removeTimezone(tz){
        const idx=this.config.additionalTimezones.indexOf(tz);if(idx>-1){
            this.config.additionalTimezones.splice(idx,1);
            const safeId=`clock-${this.sanitizeElementId(tz)}`,clockEl=document.getElementById(safeId);if(clockEl)clockEl.remove();
            this.updateTimezonesDisplay();
        }
    }
    
    updateAllClocks(){
        this.updateMainClock();
        this.config.additionalTimezones.forEach(tz=>{
            const safeId=`clock-${this.sanitizeElementId(tz)}`,clockEl=document.getElementById(safeId);if(clockEl)this.updateAdditionalClock(tz,clockEl);
        });
    }
    
    resetToDefault(){
        this.config={bgColor:'#1a1a2e',fontColor:'#ffffff',fontFamily:'Arial, sans-serif',fontSize:16,timeFormat:'24',dateFormat:'long',additionalTimezones:[]};
        const container=document.getElementById('additionalClocks');if(container)container.textContent='';
        this.applyConfig();this.startClocks();this.saveConfig();
        this.showNotification('Settings reset to default!');
    }
    
    showNotification(msg,type='success'){
        let notif=this.activeNotification;if(!notif){notif=document.createElement('div');notif.className='notification-toast';this.activeNotification=notif;}
        const cfg=type==='error'?{bg:'rgba(220,38,38,.9)',border:'rgba(220,38,38,1)',icon:'⚠️',role:'alert'}:{bg:'rgba(34,197,94,.9)',border:'rgba(34,197,94,1)',icon:'✅',role:'status'};
        this.batchUpdate(()=>{
            notif.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:${cfg.bg};color:#fff;padding:15px 20px;border-radius:8px;border:2px solid ${cfg.border};z-index:10000;box-shadow:0 10px 25px rgba(0,0,0,.2);display:flex;align-items:center;gap:10px;font-size:14px;font-weight:500;backdrop-filter:blur(10px);transition:transform .3s cubic-bezier(.4,0,.2,1)`;
            notif.setAttribute('role',cfg.role);notif.setAttribute('aria-live','polite');notif.textContent='';const iconSpan=document.createElement('span');iconSpan.style.fontSize='18px';iconSpan.textContent=cfg.icon;notif.appendChild(iconSpan);const msgSpan=document.createElement('span');msgSpan.textContent=msg;notif.appendChild(msgSpan);
        });
        document.body.appendChild(notif);
        if(this.notificationTimeout)clearTimeout(this.notificationTimeout);
        setTimeout(()=>{notif.style.transform='translateX(-50%) translateY(0)';},100);
        this.notificationTimeout=setTimeout(()=>{
            notif.style.transform='translateX(-50%) translateY(-100px)';notif.style.opacity='0';
            setTimeout(()=>{notif.remove();this.activeNotification=null;},300);
        },4000);
    }
    
    cleanup(){
        this.clockIntervals.forEach(i=>clearInterval(i));this.clockIntervals=[];
        if(this.settingsClickHandler){const s=this.getCachedElement('#settingsBtn');if(s)s.removeEventListener('click',this.settingsClickHandler);}
        if(this.keyboardHandler)document.removeEventListener('keydown',this.keyboardHandler);
        if(this.clickOutsideHandler)document.removeEventListener('click',this.clickOutsideHandler);
        if(this.notificationTimeout)clearTimeout(this.notificationTimeout);
        this.clearDOMCache();this.timezoneFormatters.clear();
    }
}

document.addEventListener('DOMContentLoaded',()=>new WorldClockWallpaper());